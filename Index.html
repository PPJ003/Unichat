<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#1a1a1a" id="themeMeta" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>UniChat Pro</title>

  <!-- PWA Manifest (Dynamic Icon & Theme) -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVW5pQ2hhdCBQcm8iLCJzaG9ydF9uYW1lIjoiVW5pQ2hhdCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIxYTFhMWEiLCJ0aGVtZV9jb2xvciI6IjFhMWExYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDE5MiAxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5Micgcng9JzM4JyBmaWxsPSclMjM0YTllZmYnLz4lM0N0ZXh0IHg9Jzk2JyB5PScxMjAnIGZvbnQtZmFtaWx5PSdBcmlhbCwgc2Fucy1zZXJpZicgZm9udC1zaXplPScxMDAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyUyM2ZmZmZmZiUzRVUlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmckeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgNTEyIDUxMiclM0UlM0NyZWN0IHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyByeD0nMTAwJyBmaWxsPSclMjM0YTllZmYnLz4lM0N0ZXh0IHg9JzI1NicgeT0nMzIwJyBmb250LWZhbWlseT0nQXJpYWwsIHNhbnMtc2VyaWYnIGZvbnQtc2l6ZT0nMjYwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSclMjNmZmZmZmYlM0VVJTNDLyZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19" id="manifestLink" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

    // REPLACE WITH YOUR FREE FIREBASE PROJECT (FREE)
    const firebaseConfig = {
      apiKey: "AIzaSyDUMMY_KEY",
      authDomain: "unichat-pro.firebaseapp.com",
      projectId: "unichat-pro",
      storageBucket: "unichat-pro.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let user = null;
    let accounts = [];
    let current = null;
    let theme = localStorage.getItem('theme') || 'dark';
    let iconColor = localStorage.getItem('iconColor') || '#4a9eff';

    function applyTheme() {
      document.body.className = theme;
      document.getElementById('themeMeta').content = theme === 'dark' ? '#1a1a1a' : '#ffffff';
      updateIcon();
      updateManifest();
    }

    function updateManifest() {
      const manifest = {
        name: "UniChat Pro",
        short_name: "UniChat",
        start_url: "/",
        display: "standalone",
        background_color: theme === 'dark' ? "#1a1a1a" : "#ffffff",
        theme_color: theme === 'dark' ? "#1a1a1a" : "#ffffff",
        icons: [
          { src: generateIcon(192), sizes: "192x192", type: "image/svg+xml" },
          { src: generateIcon(512), sizes: "512x512", type: "image/svg+xml" }
        ]
      };
      document.getElementById('manifestLink').href = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
    }

    function generateIcon(size) {
      return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${size} ${size}'%3E%3Crect width='${size}' height='${size}' rx='${size*0.2}' fill='${iconColor}'/%3E%3Ctext x='${size/2}' y='${size/1.6}' font-size='${size*0.5}' text-anchor='middle' fill='white'%3EU%3C/text%3E%3C/svg%3E`;
    }

    function updateIcon() {
      const link = document.createElement('link');
      link.rel = 'icon';
      link.href = generateIcon(100);
      const old = document.querySelector('link[rel="icon"]');
      if (old) old.remove();
      document.head.appendChild(link);
    }

    onAuthStateChanged(auth, u => {
      user = u;
      if (u) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        loadData();
      } else {
        document.getElementById('login').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
      }
    });

    window.login = () => signInWithPopup(auth, provider).catch(e => alert('Login failed: ' + e.message));
    window.logout = () => signOut(auth);

    async function loadData() {
      const snap = await getDoc(doc(db, 'users', user.uid));
      if (snap.exists()) accounts = snap.data().accounts || [];
      localStorage.setItem('accounts', JSON.stringify(accounts));
      renderAccounts();
    }

    async function saveData() {
      await setDoc(doc(db, 'users', user.uid), { accounts }, { merge: true });
      localStorage.setItem('accounts', JSON.stringify(accounts));
    }

    function renderAccounts() {
      const list = document.getElementById('accounts');
      list.innerHTML = accounts.map((a, i) => `
        <div class="acc ${current === i ? 'active' : ''}" onclick="select(${i})">
          <img src="${getServiceIcon(a.service)}" width="24" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=12 cy=12 r=10 fill=%234a9eff/%3E%3Ctext x=12 y=16 font-size=12 fill=white text-anchor=middle%3E?%3C/text%3E%3C/svg%3E'">
          <span>${a.name} <small>(${a.service})</small></span>
          <button onclick="event.stopPropagation(); del(${i})">×</button>
        </div>
      `).join('') || '<p style="text-align:center;color:#888;">No accounts. Tap +</p>';
    }

    function getServiceIcon(service) {
      const icons = {
        whatsapp: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg',
        telegram: 'https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg',
        messenger: 'https://upload.wikimedia.org/wikipedia/commons/b/be/Facebook_Messenger_logo_2020.svg',
        linkedin: 'https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png',
        slack: 'https://upload.wikimedia.org/wikipedia/commons/d/d8/Slack_Icon.png',
        'google messages': 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Google_Messages_2020.svg',
        'google chat': 'https://upload.wikimedia.org/wikipedia/commons/9/97/Google_Hangouts_Chat_icon.svg'
      };
      return icons[service.toLowerCase()] || '';
    }

    window.select = i => { current = i; renderChat(); renderAccounts(); };
    window.addAcc = () => {
      const name = prompt('Account Name (e.g. Work WhatsApp):');
      const service = prompt('Service (WhatsApp, Telegram, etc):');
      if (name && service) {
        accounts.push({ name, service, chats: [] });
        saveData();
        renderAccounts();
      }
    };
    window.del = i => {
      if (confirm('Delete account?')) {
        accounts.splice(i, 1);
        if (current === i) current = null;
        saveData();
        renderAccounts();
        renderChat();
      }
    };

    window.send = () => {
      const input = document.getElementById('msg');
      if (!input.value.trim() || current === null) return;
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      accounts[current].chats.push({ text: input.value, time, me: true });
      input.value = '';
      renderChat();
      saveData();
    };

    function renderChat() {
      if (current === null) {
        document.getElementById('chat').innerHTML = '<p style="text-align:center;color:#888;">Select an account</p>';
        return;
      }
      const c = accounts[current].chats;
      document.getElementById('chat').innerHTML = c.map(m => `
        <div class="msg ${m.me ? 'sent' : 'recv'}">
          <div class="bubble">${m.text}</div>
          <small>${m.time}</small>
        </div>
      `).join('') || '<p style="text-align:center;color:#888;">No messages</p>';
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    window.download = async () => {
      const url = prompt('Enter file/video URL:');
      if (!url) return;
      try {
        const res = await fetch(url);
        const blob = await res.blob();
        const obj = URL.createObjectURL(blob);
        const vid = document.getElementById('player');
        vid.src = obj;
        vid.style.display = 'block';
        if ('caches' in window) {
          const cache = await caches.open('downloads');
          await cache.put(url, new Response(blob));
        }
      } catch { alert('Download failed'); }
    };

    window.offline = async () => {
      const cache = await caches.open('downloads');
      const keys = await cache.keys();
      if (keys.length === 0) return alert('No offline files');
      const blob = await (await cache.match(keys[0])).blob();
      document.getElementById('player').src = URL.createObjectURL(blob);
      document.getElementById('player').style.display = 'block';
    };

    window.call = type => {
      if (current === null) return;
      const s = accounts[current].service.toLowerCase();
      const urls = {
        whatsapp: 'https://web.whatsapp.com',
        telegram: 'https://web.telegram.org',
        messenger: 'https://messenger.com',
        linkedin: 'https://linkedin.com/messaging',
        slack: 'https://app.slack.com',
        'google messages': 'https://messages.google.com/web',
        'google chat': 'https://chat.google.com'
      };
      window.open(urls[s] || urls.whatsapp, '_blank');
    };

    window.setTheme = t => {
      theme = t;
      localStorage.setItem('theme', t);
      applyTheme();
    };

    window.setIcon = () => {
      const c = prompt('Icon color (hex):', iconColor);
      if (/^#[0-9A-F]{6}$/i.test(c)) {
        iconColor = c;
        localStorage.setItem('iconColor', c);
        updateIcon();
        updateManifest();
      }
    };

    applyTheme();
  </script>

  <style>
    :root { --bg: #1a1a1a; --card: #252525; --text: #fff; --accent: #4a9eff; --input: #2a2a2a; --sent: #4a9eff; --recv: #3a3a3a; }
    .light { --bg: #f8f9fa; --card: #fff; --text: #212529; --input: #fff; --sent: #007bff; --recv: #e9ecef; }
    * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui; }
    body { background:var(--bg); color:var(--text); display:flex; flex-direction:column; height:100vh; }
    #login, #app { flex:1; display:flex; flex-direction:column; }
    #login { justify-content:center; align-items:center; text-align:center; padding:2rem; }
    .btn { background:var(--accent); color:white; border:none; padding:0.8rem 1.5rem; border-radius:12px; cursor:pointer; }
    header { background:var(--card); padding:1rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; }
    .acc { display:flex; align-items:center; gap:0.5rem; padding:0.7rem; border-radius:10px; cursor:pointer; }
    .acc.active { background:var(--accent); color:white; }
    #chat { flex:1; padding:1rem; overflow-y:auto; }
    .msg { margin:0.5rem 0; display:flex; flex-direction:column; }
    .sent { align-items:flex-end; }
    .recv { align-items:flex-start; }
    .bubble { max-width:75%; padding:0.8rem 1rem; border-radius:18px; }
    .sent .bubble { background:var(--sent); color:white; }
    .recv .bubble { background:var(--recv); }
    .input { display:flex; padding:0.8rem; background:var(--card); border-top:1px solid #333; gap:0.5rem; }
    input { flex:1; padding:0.8rem; background:var(--input); border:1px solid #444; border-radius:12px; color:var(--text); }
    #player { width:100%; max-height:50vh; display:none; margin:1rem 0; border-radius:12px; }
    .tools { display:grid; grid-template-columns:repeat(2,1fr); gap:0.5rem; padding:1rem; }
    .tool { padding:1rem; background:var(--card); border-radius:12px; text-align:center; cursor:pointer; font-size:0.9rem; }
  </style>
</head>
<body class="dark">

  <div id="login">
    <h1>UniChat Pro</h1>
    <p>Like Beeper • All-in-One • Offline</p>
    <button class="btn" onclick="login()">Sign in with Google</button>
  </div>

  <div id="app" style="display:none;">
    <header>
      <h1>UniChat</h1>
      <div>
        <button class="btn" onclick="addAcc()">+ Add</button>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <div id="accounts" style="max-height:120px;overflow-y:auto;padding:0.5rem;"></div>

    <div id="chat"></div>

    <div class="input">
      <input id="msg" placeholder="Type message..." onkeypress="if(event.key==='Enter') send()">
      <button class="btn" onclick="send()">Send</button>
    </div>

    <video id="player" controls></video>

    <div class="tools">
      <div class="tool" onclick="download()">Download</div>
      <div class="tool" onclick="offline()">Offline</div>
      <div class="tool" onclick="call('audio')">Audio Call</div>
      <div class="tool" onclick="call('video')">Video Call</div>
      <div class="tool" onclick="setIcon()">Icon</div>
      <div class="tool" onclick="setTheme(theme==='dark'?'light':'dark')">Theme</div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install",e=>e.waitUntil(caches.open("v1").then(c=>c.addAll([".","index.html"])))),self.addEventListener("fetch",e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match("index.html")))))');
    }
  </script>
</body>
    </html>
